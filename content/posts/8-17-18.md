+++ 
draft = false
date = 2018-08-17T07:18:31-06:00
title = "Provisioning a Consul / Nomad Cluster on Google Cloud with Terraform"
slug = "consul-nomad-on-gcp-terraform" 
tags = []
categories = []
+++

*Note: All code in this tutorial is available on [GitHub](https://github.com/HashedDan/gcp-consul-nomad).*

If you are moving to a microservices architecture (or even if you are not), you are most likely familiar with at least one of Hashicorp's products. Today we are going to focus on three of the company's products: Terraform, Consul, and Nomad. This post will simply detail how to setup the cluster, but there will be further posts discussing how to use its capabilities and how to structure your clusters based on your use case.

## A Brief Overview of Each Product

[**Terraform**](https://www.terraform.io/)

We will use Terraform to design our infrastructure and automatically provision our server and client nodes. It will allow us to easily create, destroy, and iterate upon our cloud architecture.

[**Consul**](https://www.consul.io/)

In the era of microservices, the concept of *service discovery* has become vitally important. If a monolithic application is to be broken down into many small services, they must be able to find and communicate with each other. Consul also allows us automatically bootstrap our Nomad cluster.

[**Nomad**](https://www.nomadproject.io/)

Once our infrastructure is provisioned by Terraform, Nomad allows us to manage it. This includes deploying, scheduling, upgrading, monitoring, and scaling applications of any kind. A good way to think of it is a less opiononated Kubernetes.

## Let's Get Started

*Note: This post assumes that you have already installed Terraform on your local machine.*

For this guide, we will be using Google Cloud becuase of their generous free credits for new users. The first thing you need to do is go to the [Google Cloud](https://cloud.google.com/) page and setup a new account by clicking Try Free.

Next, you will need to setup a new project from the Google Cloud Console. Name it whatever you like.

Lastly, we need to setup the Google Cloud SDK so that we can interact with our project from the command line. Follow this [link](https://cloud.google.com/sdk/docs/quickstarts) to find the quickstart guide for your operating system. Make sure to select the project you created when prompted.

Now we are ready to start provisioning our infrastructure!

## Building the Modules

If you are not familiar with Terraform, it uses the concept of modules to build up an infrastructure. While there are many existing Google Cloud Terraform modules already on Github, we are going to build ours from the ground up to show how Terraform works.

Let's begin by creating a directory structure for our project:

```
/ gcp-consul-nomad
    / modules
        / cluster
    / scripts
```

In our top-level directory (gcp-consul-nomad), we will build our main Terraform configuration, making use of the modules and scripts defined in their respective directories.

#### The Server / Client Model

Both Consul and Nomad use a Server / Client structure where the servers orchestrate the clients. For this post, we will be building a cluster of 3 Consul / Nomad servers, and a cluster of 2 Consul / Nomad clients. What this means is that we will provision a total of 5 compute instances, 3 of which will be running the Consul and Nomad binaries in server mode, and 2 of which will be running the Consul and Nomad binaries in client mode.

Let's start with building out the ```cluster```. Navigate to the directory and create the following two files: ```main.tf``` and ```variables.tf```. The main file is where we will build the modules, and we will define the variables used in the main file in the variables file.

There are a couple of ways you could go about provisioning compute instances on GCP. We are going to provision ours with an *image template* and a *compute instance group manager*. Alternatively, you could manually build each compute instance. The group manager allows us to provision multiple instances from the same image template, which comes in handy when we need a collection of identical machines to be allocated.

#### Scaffolding the Compute Instance Template

Terraform refers to cloud provider services as *resources*. As previously mentioned, the first resource we are going to be building is the image template.

In the ```main.tf``` file, insert the following stanza:
```
resource "google_compute_instance_template" "server_template" {
  count   = ""
  project = ""

  name_prefix  = ""
  machine_type = ""
  region       = ""

  tags = ""

  disk {}

  network_interface {}

  metadata = ""

  service_account {}
}
```
This is the basic outline for the instance template. If you have questions about the specific properties defined within it (or what other options are available), you can look at the Google Provider [google_compute_instace_template](https://www.terraform.io/docs/providers/google/r/compute_instance_template.html) section in the Terraform documentation. However, we will go through one-by-one and populate the properties, describing why we are doing so for each property.

#### Thinking About Variables

Before we get started, one aspect of Terraform that is important to understand is the ability to use variables. Variables must be defined in a ```variables.tf``` file, and they represent values that a user may want to define. So, when creating modules, we want to think about **what parts of that module are important to assign user-defined variables to in order to make it customizable and reusable?** It is good to keep in mind that, typically, the more variables in a module, the more reusable it will be, but the more complex it will be to use as well (this is a tradeoff that you must consider when building Terraform modules for your organization).

> It is good to keep in mind that, typically, the more variables in a module, the more reusable it will be, but the more complex it will be to use as well (this is a tradeoff that you must consider when building Terraform modules for your organization).

#### Populating the Compute Instance Template

In populating the compute instance parameters, I am going to err on the side of more reusable, due to the fact that this is an open project that I want others to be able to customize as they see fit.

The first parameter is ```count```. Count refers to the number of templates that we want to be generated when this module is envoked. Remember, this does not refer to the number of compute instances, they are simply generated from this template. Therefore, the user of this module likely only wants 1 or 0 templates. Knowing this, we will write a conditional based on a variable that the user can define:
```
count   = "${var.module_enabled ? 1 : 0}"
```
Essentially this is just the user saying that they either want to generate the template or not. Now that we have defined the ```module_enabled``` variable in the main file, we must make a corresponding entry in the variables file:
```
variable module_enabled {
  description = "Denotes whether a template should be generated or not."
  default     = true
}
```
We have defined a description to ensure the user understands what the variable is for, but we have also defined a default value. If a variable is defined with a default value, the user is not required to define it when using the module, and if they don't it will default to that value.

Next, we have the ```project``` parameter. Google organizes cloud resources around projects, and anything provisioned in Google Cloud Platform must be associated with a given project. This will clearly be something we want the user to define, so we will once again declare one in main.tf:
```
project = "${var.project}"
```
And in variables.tf:
```
variable project {
  description = "The project to deploy to, if not set the default provider project is used."
  default     = ""
}
```
The next parameter is ```name_prefix```. Since this resource will always create an instance template, we can make the assumption that the user of the module will always want to prefix the resource with something like "instance-template" (once again, in another situation, you may want the user of the module to be able to customize this parameter). We can simply set the value in main.tf:
```
name_prefix  = "instance-template-"
```

## Questions & Thoughts

If you have any questions or thoughts, please contact me on Twitter [@HashedDan](https://twitter.com/HashedDan)!